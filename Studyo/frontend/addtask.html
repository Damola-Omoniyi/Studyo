<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Studyo</title>
</head>
<body>
<h1>Studyo</h1>

<form id ="task">
    <input type="text" id="taskName" name="taskName" placeholder="Task Name" required /> <br><br>
    <input type="date" id="startDate" name="startDate"  required /> <br><br>
    <input type="date" id="deadline" name="deadline" required /> <br><br>
    <select id="urgency" name="urgency" required>
        <option value ="" disabled selected>Urgency</option>
        <option value ="High">High</option>
        <option value ="Medium">Medium</option>
        <option value ="Low">Low</option>
    </select> <br><br>

    <textarea id="description" name="description" placeholder="Task Description" required></textarea>
    <br><br>
    <button type="submit">Create Task</button>
</form>
</body>
<script>
  // Add this at the top of your script
const csrfToken = localStorage.getItem('csrfToken');

const form = document.getElementById('task');
form.addEventListener('submit', async(event) => {
    event.preventDefault();

    // First verify session
    const sessionCheck = await checkSession();
    if (!sessionCheck.authenticated) {
        alert('Please login first');
        window.location.href = 'login.html';
        return;
    }

    const taskData = {
        taskName: document.getElementById('taskName').value,
        startDate: document.getElementById('startDate').value,
        deadline: document.getElementById('deadline').value,
        urgency: document.getElementById('urgency').value,
        description: document.getElementById('description').value
    };

    try {
        const response = await fetch("http://127.0.0.1:8000/api/create-task/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken  // Include CSRF token
            },
            credentials: 'include',  // Important for cookies
            body: JSON.stringify(taskData)
        });

        const result = await response.json();
        alert("Task created successfully: " + JSON.stringify(result));
    } catch(err) {
        alert("Task creation failed: " + err.message);
    }
});

// Reuse the same checkSession function
async function checkSession() {
    try {
        const response = await fetch('http://127.0.0.1:8000/api/check-session/', {
            credentials: 'include'
        });
        return await response.json();
    } catch (error) {
        return {authenticated: false};
    }
}
</script>
</html>